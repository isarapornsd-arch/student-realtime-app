<!DOCTYPE html>
<html lang="th">
<head>
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:'Sarabun',sans-serif;background:#93c5fd;margin:0;display:flex;justify-content:center;}
.container{background:white;border-radius:20px;padding:25px;width:95%;max-width:900px;margin-top:20px;text-align:center;}
.hidden{display:none;}
button{padding:10px 20px;border:none;border-radius:8px;color:white;margin:5px;font-weight:bold;cursor:pointer;}
.btn-green{background:#10b981;}
.btn-purple{background:#8b5cf6;}
.btn-primary{background:#2563eb;}
.btn-red{background:#ef4444;}
.btn-gray{background:#6b7280;}
input{padding:10px;border-radius:8px;border:1px solid #ccc;text-align:center;}
.choices button{width:60px;height:60px;border-radius:50%;border:2px solid #ccc;background:white;}
.choices button.selected{background:#2563eb;color:white;}
#popup{position:fixed;top:30%;left:50%;transform:translate(-50%,-50%);background:#10b981;color:white;padding:15px 25px;border-radius:12px;display:none;}
.responses-list{margin-top:15px;background:#f1f5f9;border-radius:10px;max-height:300px;overflow:auto;}
.response-item{padding:6px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;}
</style>
</head>

<body>
<div class="container">

<!-- HOME -->
<div id="homePage">
<h1>ğŸ“˜ à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ Realtime</h1>
<button class="btn-green" id="toStudent">ğŸ“ à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</button>
<button class="btn-purple" id="toTeacher">ğŸ‘©â€ğŸ« à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="hidden">
<h2>ğŸ“ à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</h2>
<input type="number" id="student_id" placeholder="à¸£à¸«à¸±à¸ªà¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²">
<h3>à¹€à¸¥à¸·à¸­à¸à¸„à¸³à¸•à¸­à¸š</h3>
<div class="choices">
<button data-choice="A">A</button>
<button data-choice="B">B</button>
<button data-choice="C">C</button>
<button data-choice="D">D</button>
<button data-choice="E">E</button>
</div>
<br>
<button class="btn-green" id="submitBtn">à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸š</button>
<button class="btn-gray" id="resetBtn">à¸£à¸µà¹€à¸‹à¹‡à¸•</button>
<button class="btn-primary" id="backHome1">ğŸ  à¸à¸¥à¸±à¸š</button>
<p id="status"></p>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="hidden">
<h2>ğŸ‘©â€ğŸ« à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</h2>
<button class="btn-red" id="clearScreenBtn">ğŸ§¼ à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆ</button>
<button class="btn-green" id="exportExcelBtn">ğŸ“¥ Export Excel</button>
<div id="chartsContainer"></div>
<div id="responsesList" class="responses-list"></div>
<button class="btn-primary" id="backHome2">ğŸ  à¸à¸¥à¸±à¸š</button>
</div>
</div>

<div id="popup">à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
 "https://ebqmunvfantlffbqvybx.supabase.co",
 "YOUR_API_KEY"
);

let currentRound = 1;
let questionNumber = 1;
let selectedChoice = null;

// âœ… à¹‚à¸«à¸¥à¸”à¸£à¸­à¸šà¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ Supabase
async function loadCurrentRound(){
 const { data } = await supabase.from("game_state").select("current_round").eq("id",1).single();
 currentRound = data.current_round;
 questionNumber = currentRound;
}
await loadCurrentRound();

// PAGE NAV
homePage = homePage=document.getElementById("homePage");
studentPage = studentPage=document.getElementById("studentPage");
teacherPage = teacherPage=document.getElementById("teacherPage");

toStudent.onclick=()=>{homePage.classList.add("hidden");studentPage.classList.remove("hidden");}
toTeacher.onclick=()=>{
 if(prompt("à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ")=="2568"){
 homePage.classList.add("hidden");teacherPage.classList.remove("hidden");}
};

backHome1.onclick=()=>{studentPage.classList.add("hidden");homePage.classList.remove("hidden");}
backHome2.onclick=()=>{teacherPage.classList.add("hidden");homePage.classList.remove("hidden");}

// POPUP
function showPopup(text){
 const p=document.getElementById("popup");
 p.innerText=text;p.style.display="block";
 setTimeout(()=>p.style.display="none",2000);
}

// SELECT CHOICE
document.querySelectorAll(".choices button").forEach(btn=>{
 btn.onclick=()=>{
  document.querySelectorAll(".choices button").forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedChoice=btn.dataset.choice;
 };
});

// âœ… SUBMIT
submitBtn.onclick=async ()=>{
 const student_id=document.getElementById("student_id").value;
 if(!student_id||!selectedChoice) return alert("à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");

 const { data:existing }=await supabase.from("attendance")
 .select("*").eq("student_id",student_id)
 .eq("round_id",currentRound);

 if(existing.length>0) return alert("âŒ à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§");

 await supabase.from("attendance").insert([{
  student_id,
  round_id:currentRound,
  question_number:questionNumber,
  choice:selectedChoice,
  created_at:new Date()
 }]);

 showPopup("âœ… à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
 status.innerText="à¸ªà¹ˆà¸‡ "+selectedChoice+" à¹à¸¥à¹‰à¸§";
};

// âœ… RESET
resetBtn.onclick=()=>{
 document.getElementById("student_id").value="";
 document.querySelectorAll(".choices button").forEach(b=>b.classList.remove("selected"));
 selectedChoice=null;status.innerText="";
};

// âœ… TEACHER NEW ROUND (à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²à¸«à¸¥à¸±à¸)
clearScreenBtn.onclick=async ()=>{
 currentRound++;
 await supabase.from("game_state").update({current_round:currentRound}).eq("id",1);
 showPopup("ğŸ†• à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆ");
};

// âœ… STUDENT REALTIME SYNC ROUND
supabase.channel("game_state")
.on("postgres_changes",{event:"UPDATE",schema:"public",table:"game_state"},
 payload=>{
  currentRound=payload.new.current_round;
  questionNumber=currentRound;
  showPopup("ğŸ†• à¸‚à¹‰à¸­à¹ƒà¸«à¸¡à¹ˆ!");
 })
.subscribe();

// âœ… LOAD RESULTS
async function loadAll(){
 const { data }=await supabase.from("attendance").select("*");
 let html="";
 data.forEach(r=>{
  html+=`<div class="response-item">
  <span>${r.student_id}</span><b>${r.choice}</b></div>`;
 });
 responsesList.innerHTML=html;
}
loadAll();

supabase.channel("attendance")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"attendance"},()=>loadAll())
.subscribe();
</script>

</body>
</html>
